name: Default Workflow
on:
  push:
    branches:
      - '**'

jobs:
  Prepare:
    timeout-minutes: 5
    runs-on: ubuntu-24.04
    outputs:
      images: ${{ steps.images.outputs.images }}
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      - name: Prepare the Matrix
        id: images
        run: |
          IMAGES=""
          for i in *; do
            if [ -d "$i" ] && [ -e "$i/Dockerfile" ]; then
              if [ -z "$IMAGES" ]; then
                IMAGES="$i"
              else
                IMAGES="$IMAGES,$i"
              fi
            fi
          done
          echo "images=$(echo -n $IMAGES | jq -R -c 'split(",")')" >> $GITHUB_OUTPUT

  Build:
    needs: Prepare
    timeout-minutes: 20
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        image: ${{ fromJson(needs.Prepare.outputs.images) }}
    name: Build ${{ matrix.image }}
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      - name: Extract Image Tag from Dockerfile
        id: extract_tag
        run: |
          TAG=$(awk '/^FROM / {print $2; exit}' "${{ matrix.image }}/Dockerfile" | cut -d':' -f2)
          echo "tag=$TAG" #>> $GITHUB_ENV
      # - name: Build container
      #   uses: docker/build-push-action@v6
      #   with:
      #     file: "${{ matrix.image }}/Dockerfile"
      #     push: true
      #     tags: "ghcr.io/Userlane/${{ matrix.image }}:${{ env.tag }}"
